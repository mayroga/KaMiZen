<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>KaMiZen - Sesi√≥n diaria</title>
<link rel="stylesheet" href="/static/style.css">
<style>
body { background:#111; color:#eee; font-family: Arial, sans-serif; }
#sessionContainer { max-width:800px; margin:auto; padding:20px; }
#participants,#timeRemaining,#feedback,#ranking { margin-bottom:10px; }
#questionBox { background:#222; padding:15px; border-radius:8px; margin-bottom:10px; font-size:1.2em; min-height:60px; }
#answerInput,#chatInput { width:100%; padding:10px; margin-bottom:5px; border-radius:5px; border:none; }
#chatBox { background:#222; padding:10px; height:200px; overflow-y:auto; border-radius:8px; margin-bottom:10px; }
button { padding:10px 20px; border:none; border-radius:5px; background:#ff4d4d; color:#fff; font-weight:bold; cursor:pointer; }
button:hover { background:#ff1a1a; }
.timer { font-size:1.2em; font-weight:bold; }
.chatMessage { margin-bottom:4px; }
.simulated { color:#ffcc00; font-weight:bold; }
#rankingList { margin-top:5px; }
.level { font-weight:bold; color:#00ffcc; }
</style>
</head>
<body>
<div id="sessionContainer">
    <h1>KaMiZen - Sesi√≥n diaria</h1>

    <div id="participants">üî• Conectados: 1/500</div>
    <div class="timer">‚è≥ Tiempo restante: <span id="timeRemaining">10:00</span></div>
    <div id="ranking">
        üèÜ Top 5 del momento
        <div id="rankingList"></div>
    </div>

    <div id="questionBox">Cargando pregunta...</div>
    <input type="text" id="answerInput" placeholder="Escribe tu respuesta aqu√≠...">
    <button onclick="sendAnswer()">Enviar</button>
    <div id="feedback"></div>

    <h3>Chat en vivo (an√≥nimo)</h3>
    <div id="chatBox">Cargando chat...</div>
    <input type="text" id="chatInput" placeholder="Escribe mensaje...">
    <button onclick="sendChat()">Enviar</button>

    <audio id="sessionAudio" autoplay></audio>
</div>

<script>
let ws = new WebSocket(`ws://${window.location.host}/ws`);
let timeRemaining = 10 * 60; // 10 minutos
let timerInterval;

const participantsDiv = document.getElementById("participants");
const rankingList = document.getElementById("rankingList");
const questionBox = document.getElementById("questionBox");
const answerInput = document.getElementById("answerInput");
const feedbackDiv = document.getElementById("feedback");
const chatBox = document.getElementById("chatBox");
const chatInput = document.getElementById("chatInput");
const sessionAudio = document.getElementById("sessionAudio");

// ---------------------------
// Temporizador sesi√≥n
// ---------------------------
function startTimer() {
    timerInterval = setInterval(() => {
        timeRemaining--;
        let min = Math.floor(timeRemaining / 60).toString().padStart(2, "0");
        let sec = (timeRemaining % 60).toString().padStart(2, "0");
        document.getElementById("timeRemaining").innerText = `${min}:${sec}`;
        if (timeRemaining <= 0) {
            clearInterval(timerInterval);
            questionBox.innerText = "‚è∞ Sesi√≥n finalizada. ¬°Ma√±ana subimos nivel!";
            answerInput.disabled = true;
            chatInput.disabled = true;
            sessionAudio.pause();
        }
    }, 1000);
}

// ---------------------------
// WebSocket mensajes
// ---------------------------
ws.onmessage = (event) => {
    let data = JSON.parse(event.data);
    if (data.type === "update_participants") {
        participantsDiv.innerText = `üî• Conectados: ${data.count}/${data.max}`;
    } else if (data.type === "update_ranking") {
        rankingList.innerHTML = "";
        data.ranking.forEach(u => {
            let div = document.createElement("div");
            div.innerHTML = `${u.name} - <span class="level">${u.level}</span>`;
            rankingList.appendChild(div);
        });
    } else if (data.type === "question") {
        questionBox.innerText = data.text;
        // Audio pregrabado por fase
        if(timeRemaining > 9*60) sessionAudio.src = "/static/audio/monday.mp3"; // Corte digital
        else if(timeRemaining > 6*60) sessionAudio.src = "/static/audio/thursday.mp3"; // Activaci√≥n mental / acci√≥n
        else sessionAudio.src = "/static/audio/monday.mp3"; // Cierre y tensi√≥n
        sessionAudio.play();
    } else if (data.type === "feedback") {
        feedbackDiv.innerText = data.text;
    } else if (data.type === "chat") {
        let div = document.createElement("div");
        div.className = `chatMessage ${data.simulated ? "simulated" : ""}`;
        div.innerText = `${data.sender}: ${data.text}`;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }
};

// ---------------------------
// Enviar respuesta
// ---------------------------
function sendAnswer() {
    let text = answerInput.value.trim();
    if (text) {
        ws.send(JSON.stringify({type: "answer", text}));
        answerInput.value = "";
    }
}

// ---------------------------
// Enviar chat
// ---------------------------
function sendChat() {
    let text = chatInput.value.trim();
    if (text) {
        ws.send(JSON.stringify({type: "chat", text}));
        chatInput.value = "";
    }
}

// ---------------------------
// Iniciar sesi√≥n
// ---------------------------
startTimer();
</script>
</body>
</html>
