<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #000; font-family: 'Georgia', serif; color: white; }
        #mapa-fondo { position: absolute; width: 100%; height: 100vh; background-size: cover; background-position: center; transition: 5s ease; filter: brightness(0.35); }
        #caminante { position: absolute; top: 40%; left: 0%; font-size: 80px; transition: 3s linear; z-index: 10; filter: drop-shadow(0 0 15px gold); }
        #narrativa { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.9); padding: 40px; text-align: center; border-top: 2px solid #D4AF37; z-index: 20; box-sizing: border-box; }
        #texto-display { font-size: 1.6rem; min-height: 80px; margin-bottom: 20px; color: #EEE; }
        .btn-kmz { background: none; border: 1px solid #D4AF37; color: gold; padding: 15px 30px; margin: 10px; cursor: pointer; font-size: 1rem; transition: 0.3s; }
        .btn-kmz:hover { background: #D4AF37; color: black; }
        .gold-rain { position: absolute; background: gold; border-radius: 50%; pointer-events: none; z-index: 100; animation: fall 2s linear forwards; }
        @keyframes fall { to { transform: translateY(100vh); opacity: 0; } }
        input { background: none; border: 1px solid gold; color: white; padding: 15px; font-size: 1.2rem; text-align: center; width: 300px; }
    </style>
</head>
<body>
    <div id="mapa-fondo"></div>
    <div id="caminante">üö∂‚Äç‚ôÇÔ∏è</div>
    <div id="narrativa">
        <div id="texto-display">Iniciando protocolo KaMiZen...</div>
        <div id="control"></div>
    </div>
    <audio id="audio-player"></audio>

    <script>
        function rain() {
            for(let i=0; i<30; i++){
                let p = document.createElement('div');
                p.className = 'gold-rain';
                p.style.width = p.style.height = Math.random()*4+'px';
                p.style.left = Math.random()*100+'vw';
                p.style.top = '-10px';
                document.body.appendChild(p);
                setTimeout(() => p.remove(), 2000);
            }
        }

        async function ciclo() {
            const res = await fetch('/api/get_sequence');
            const data = await res.json();

            // Mover caminante 10% por fase
            document.getElementById('caminante').style.left = (data.fase * 9) - 5 + "%";
            document.getElementById('mapa-fondo').style.backgroundImage = `url(${data.bg})`;
            document.getElementById('texto-display').innerText = data.texto;

            const player = document.getElementById('audio-player');
            player.src = `/api/get_audio?text=${encodeURIComponent(data.texto)}`;
            player.play();

            const ctrl = document.getElementById('control');
            ctrl.innerHTML = '';

            if(data.input_requerido) {
                const i = document.createElement('input');
                i.placeholder = "Escribe tu ciudad...";
                i.onkeypress = async (e) => {
                    if(e.key === 'Enter'){
                        await fetch('/api/set_origen', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({origen: i.value})});
                        rain(); ciclo();
                    }
                };
                ctrl.appendChild(i);
            } else if(data.opciones) {
                data.opciones.forEach(o => {
                    const b = document.createElement('button');
                    b.className = 'btn-kmz';
                    b.innerText = o;
                    b.onclick = () => { rain(); ciclo(); };
                    ctrl.appendChild(b);
                });
            }

            player.onended = () => {
                if(data.finalizado) window.location.href = '/logout';
                else if(!data.opciones && !data.input_requerido) setTimeout(ciclo, 6000);
            };
        }
        window.onload = ciclo;
    </script>
</body>
</html>
