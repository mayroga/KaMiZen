<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #000; font-family: 'Georgia', serif; color: white; }
        #mapa-fondo { position: absolute; width: 100%; height: 100vh; background-size: cover; background-position: center; transition: 4s ease; filter: brightness(0.4); }
        #caminante { position: absolute; top: 42%; left: 0%; font-size: 85px; transition: 3s linear; z-index: 10; }
        
        #narrativa { 
            position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.85); 
            padding: 40px; text-align: center; border-top: 3px solid #D4AF37; box-sizing: border-box; z-index: 20;
        }

        #texto-display { 
            font-size: 1.8rem; line-height: 1.4; color: #FFF; 
            min-height: 100px; max-width: 900px; margin: 0 auto;
        }

        .fade-out { opacity: 0; transition: opacity 1.5s ease; }
        .fade-in { opacity: 1; transition: opacity 0.5s ease; }

        .btn-kmz { background: none; border: 1px solid gold; color: gold; padding: 15px 35px; margin: 10px; cursor: pointer; font-size: 1.1rem; }
        .btn-kmz:hover { background: gold; color: black; }
        
        input { background: none; border: 1px solid gold; color: white; padding: 15px; font-size: 1.3rem; text-align: center; }
    </style>
</head>
<body>
    <div id="mapa-fondo"></div>
    <div id="caminante">üö∂‚Äç‚ôÇÔ∏è</div>
    <div id="narrativa">
        <div id="texto-display">Activando KaMiZen...</div>
        <div id="control"></div>
    </div>
    <audio id="audio-player"></audio>

    <script>
        function escribirRapido(elemento, texto) {
            elemento.innerText = "";
            elemento.classList.remove('fade-out');
            elemento.classList.add('fade-in');
            let i = 0;
            let speed = 30; 
            function type() {
                if (i < texto.length) {
                    elemento.innerHTML += texto.charAt(i);
                    i++;
                    setTimeout(type, speed);
                }
            }
            type();
        }

        async function ciclo() {
            const res = await fetch('/api/get_sequence');
            const data = await res.json();

            // Actualizar fondo y posici√≥n
            document.getElementById('mapa-fondo').style.backgroundImage = `url(${data.bg})`;
            document.getElementById('caminante').style.left = (data.fase * 9) - 5 + "%";

            const display = document.getElementById('texto-display');
            escribirRapido(display, data.texto);

            const player = document.getElementById('audio-player');
            player.src = `/api/get_audio?text=${encodeURIComponent(data.texto)}`;
            player.play();

            const ctrl = document.getElementById('control');
            ctrl.innerHTML = '';

            if(data.input_requerido) {
                const i = document.createElement('input');
                i.placeholder = "Ciudad de origen...";
                i.onkeypress = async (e) => {
                    if(e.key==='Enter') {
                        await fetch('/api/set_origen', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({origen:i.value})});
                        ciclo();
                    }
                };
                ctrl.appendChild(i);
            } else if(data.opciones) {
                data.opciones.forEach(o => {
                    const b = document.createElement('button');
                    b.className = 'btn-kmz';
                    b.innerText = o;
                    b.onclick = () => ciclo();
                    ctrl.appendChild(b);
                });
            }

            // Desvanecer letras antes de terminar el audio para dinamismo
            setTimeout(() => {
                display.classList.add('fade-out');
            }, 12000); 

            player.onended = () => {
                if(data.finalizado) window.location.href = '/logout';
                else if(!data.opciones && !data.input_requerido) setTimeout(ciclo, 2000);
            };
        }
        window.onload = ciclo;
    </script>
</body>
</html>
