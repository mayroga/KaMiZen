<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KaMiZen - Camino Vivo</title>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #000; font-family: 'Segoe UI', serif; }
        #mapa-fondo { 
            position: absolute; width: 100%; height: 100vh; 
            background: url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1920&q=80') no-repeat center center; 
            background-size: cover; filter: brightness(0.6); transition: 2s;
        }
        #caminante { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 60px; transition: 3s; z-index: 10;
        }
        #narrativa-container { 
            position: absolute; bottom: 0; width: 100%; 
            background: rgba(0, 0, 0, 0.85); color: white; 
            padding: 30px; box-sizing: border-box; z-index: 20;
            border-top: 3px solid #d4af37; text-align: center;
        }
        .frase-flotante {
            position: absolute; color: #d4af37; font-style: italic; font-size: 1.2rem;
            animation: moveUp 8s forwards; pointer-events: none; opacity: 0.8;
        }
        @keyframes moveUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(-100px); } }
        
        /* Puzzle de Im√°genes */
        #puzzle-container { display: none; gap: 10px; justify-content: center; margin-top: 20px; }
        .puzzle-piece { width: 100px; height: 100px; border: 2px solid #d4af37; cursor: grab; background-size: cover; }

        .botones-grid { display: none; gap: 15px; justify-content: center; margin-top: 20px; flex-wrap: wrap; }
        .btn-kmz { 
            background: rgba(212, 175, 55, 0.2); border: 1px solid #d4af37; color: white; 
            padding: 12px 25px; cursor: pointer; transition: 0.3s;
        }
        .btn-kmz:hover { background: #d4af37; color: black; }
    </style>
</head>
<body>

    <div id="mapa-fondo">
        <div id="caminante">üö∂‚Äç‚ôÇÔ∏è</div>
        <div id="puzzle-container"></div>
    </div>

    <div id="narrativa-container">
        <div id="texto-display" style="font-size: 1.3rem;">Escuchando el murmullo del camino...</div>
        <div id="botones" class="botones-grid"></div>
    </div>

    <audio id="audio-player"></audio>

    <script>
        const textoDisplay = document.getElementById('texto-display');
        const audioPlayer = document.getElementById('audio-player');
        const botonesDiv = document.getElementById('botones');
        const puzzleDiv = document.getElementById('puzzle-container');

        function crearFrase(txt) {
            const f = document.createElement('div');
            f.className = 'frase-flotante';
            f.innerText = txt;
            f.style.left = Math.random() * 80 + '%';
            f.style.top = '60%';
            document.body.appendChild(f);
            setTimeout(() => f.remove(), 8000);
        }

        async function ciclo() {
            const res = await fetch('/api/get_sequence');
            const data = await res.json();

            textoDisplay.innerText = data.texto;
            
            // Audio Onyx
            audioPlayer.src = `/api/get_audio?text=${encodeURIComponent(data.texto)}`;
            audioPlayer.play();

            // L√≥gica de Rompecabezas
            if (data.tipo === "rompecabezas") {
                puzzleDiv.style.display = 'flex';
                puzzleDiv.innerHTML = '';
                data.imagenes.forEach(img => {
                    const div = document.createElement('div');
                    div.className = 'puzzle-piece';
                    div.style.backgroundImage = `url(${img})`;
                    div.onclick = () => { div.style.borderColor = '#fff'; };
                    puzzleDiv.appendChild(div);
                });
            } else {
                puzzleDiv.style.display = 'none';
            }

            // L√≥gica de Botones (Adivinanzas/Obst√°culos)
            if (data.opciones && data.opciones.length > 0) {
                botonesDiv.style.display = 'flex';
                botonesDiv.innerHTML = '';
                data.opciones.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = 'btn-kmz';
                    btn.innerText = opt;
                    btn.onclick = () => {
                        botonesDiv.style.display = 'none';
                        puzzleDiv.style.display = 'none';
                        crearFrase("Elecci√≥n sabia...");
                        ciclo();
                    };
                    botonesDiv.appendChild(btn);
                });
            }

            audioPlayer.onended = () => {
                if (data.finalizado) {
                    window.location.href = '/logout';
                } else if (!data.opciones || data.opciones.length === 0) {
                    crearFrase("La sabidur√≠a requiere silencio...");
                    setTimeout(ciclo, 7000); // Pausa de reflexi√≥n
                }
            };
        }

        window.onload = ciclo;
    </script>
</body>
</html>
