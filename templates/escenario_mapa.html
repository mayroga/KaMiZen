<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
<meta charset="UTF-8">
<title>KaMiZen Journey</title>
<style>
body,html{margin:0;height:100%;background:black;color:white;font-family:Georgia}
#bg{position:fixed;width:100%;height:100%;background-size:cover;filter:brightness(.6);transition:2s}
#walker{position:absolute;top:45%;left:50%;transform:translate(-50%,-50%);font-size:80px}
#panel{position:fixed;bottom:0;width:100%;background:rgba(0,0,0,.85);padding:20px;text-align:center}
#controls{position:fixed;top:15px;right:15px;display:flex;gap:10px}
button{background:black;color:#FFD700;border:1px solid #FFD700;padding:8px 12px;cursor:pointer}
</style>
</head>
<body>

<div id="bg"></div>
<div id="walker">üö∂‚Äç‚ôÇÔ∏è</div>

<div id="controls">
<button onclick="setLang('es')">ES</button>
<button onclick="setLang('en')">EN</button>
<button onclick="skip()">‚è© SALTAR</button>
</div>

<div id="panel">
<div id="texto">Iniciando viaje‚Ä¶</div>
</div>

<audio id="audio"></audio>

<script>
const textoDiv = document.getElementById("texto");
const bg = document.getElementById("bg");
const audio = document.getElementById("audio");

async function setLang(l){
    await fetch("/api/lang",{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({lang:l})});
    ciclo();
}

async function skip(){
    await fetch("/api/skip");
    ciclo();
}

async function ciclo(){
    const r = await fetch("/api/sequence");
    const d = await r.json();

    textoDiv.innerText = d.texto;
    bg.style.backgroundImage = `url(${d.bg})`;

    audio.src = `/api/audio?text=${encodeURIComponent(d.texto)}`;
    audio.play().catch(()=>{});

    audio.onended = () => {
        if(!d.final){
            setTimeout(ciclo, 1500);
        } else {
            textoDiv.innerText += " üåü";
        }
    };
}

window.onload = ciclo;
</script>
</body>
</html>
