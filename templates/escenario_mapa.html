<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        #map { 
            height: 100vh; 
            width: 100%; 
            filter: sepia(0.2) saturate(1.2) contrast(0.9) brightness(1.05);
            z-index: 1;
        }

        #text-container {
            position: absolute;
            top: 5%;
            left: 50%;
            transform: translateX(-50%);
            width: 85%;
            max-width: 850px;
            background: rgba(255, 255, 255, 0.9); 
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            z-index: 2000;
            text-align: center;
            font-size: 1.5rem;
            color: #1a1a1a;
            line-height: 1.5;
        }

        .walker-icon {
            font-size: 40px;
            text-align: center;
            animation: bounce 1.2s infinite ease-in-out;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
    </style>
</head>
<body>

    <div id="text-container"><span id="typewriter"></span></div>
    <div id="map"></div>

    <audio id="voice-player" style="display:none;"></audio>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Recuperar idioma seleccionado en el index
        const userLang = localStorage.getItem('kmz_lang') || 'en';

        const lat = {{ latitud|default(25.7617) }}; 
        const lng = {{ longitud|default(-80.1918) }};

        const map = L.map('map', {
            zoomControl: false,
            attributionControl: false,
            dragging: false,
            scrollWheelZoom: false
        }).setView([lat, lng], 17);

        L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png').addTo(map);

        const marker = L.marker([lat, lng], {
            icon: L.divIcon({ 
                className: 'custom-div-icon', 
                html: "<div class='walker-icon'>üö∂‚Äç‚ôÇÔ∏è</div>", 
                iconSize: [40, 50] 
            })
        }).addTo(map);

        async function cargarNuevaExperiencia() {
            // Conexi√≥n corregida al endpoint del main.py con el idioma
            const response = await fetch(`/api/get_content?lang=${userLang}`);
            const data = await response.json();
            
            const displayElement = document.getElementById('typewriter');
            const audioPlayer = document.getElementById('voice-player');
            
            displayElement.innerHTML = ""; 
            let i = 0;
            const textoFull = data.texto + " ... " + data.reflexion;

            function typeWriter() {
                if (i < textoFull.length) {
                    displayElement.innerHTML += textoFull.charAt(i);
                    i++;
                    setTimeout(typeWriter, 45); 
                } else {
                    // Al terminar de escribir, suena la voz masculina Onyx
                    audioPlayer.src = data.audio_url;
                    audioPlayer.play();
                }
            }
            typeWriter();
        }

        window.onload = cargarNuevaExperiencia;

        let currentLat = lat;
        setInterval(() => {
            currentLat += 0.00008; 
            marker.setLatLng([currentLat, lng]);
            map.panTo([currentLat, lng], {animate: true, duration: 2});
        }, 3000);

        // Cada 3 minutos cambia la historia para mantener el flujo de 10 min
        setInterval(cargarNuevaExperiencia, 180000);
    </script>
</body>
</html>
