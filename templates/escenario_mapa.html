<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body, html { margin: 0; padding: 0; height: 100%; background: #000; overflow: hidden; }
        #map { height: 100vh; width: 100%; filter: grayscale(0.2) contrast(1.1); }
        #narrative-overlay {
            position: absolute; bottom: 10%; left: 50%; transform: translateX(-50%);
            width: 80%; text-align: center; z-index: 1000;
            color: white; font-size: 1.4rem; text-shadow: 0 2px 10px rgba(0,0,0,0.8);
        }
        .ui-controls { position: absolute; top: 20px; right: 20px; z-index: 2000; display: flex; gap: 10px; }
        button { background: rgba(255,255,255,0.9); border: none; padding: 10px 20px; cursor: pointer; font-weight: bold; }
        .walker { font-size: 50px; text-shadow: 0 0 10px white; }
    </style>
</head>
<body>

<div class="ui-controls">
    <button onclick="window.print()">PDF</button>
    <button onclick="location.href='/pago-exitoso'" style="color: red;">BORRAR</button>
</div>

<div id="narrative-overlay"></div>
<div id="map"></div>
<audio id="onyx-voice"></audio>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map', { zoomControl: false, dragging: false }).setView([25.7617, -80.1918], 18);
    L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png').addTo(map);

    const marker = L.marker([25.7617, -80.1918], {
        icon: L.divIcon({ className: 'walker', html: "ðŸš¶â€â™‚ï¸" })
    }).addTo(map);

    async function fluirSesion() {
        const res = await fetch(`/api/get_content?lang=es`);
        const data = await res.json();
        
        // Regla 9: Primero el texto sutil, luego la voz con peso
        document.getElementById('narrative-overlay').innerText = data.texto;
        
        const audio = document.getElementById('onyx-voice');
        audio.src = `/api/get_audio?text=${encodeURIComponent(data.reflexion)}`;
        audio.play();
        
        audio.onended = () => {
            setTimeout(fluirSesion, 15000); // Pausa de integraciÃ³n (Regla 12)
        };
    }

    // Movimiento constante y suave (Regla 6)
    let lat = 25.7617;
    setInterval(() => {
        lat += 0.00002;
        marker.setLatLng([lat, -80.1918]);
        map.panTo([lat, -80.1918]);
    }, 2000);

    window.onload = fluirSesion;
</script>
</body>
</html>
