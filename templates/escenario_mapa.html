<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #000; font-family: 'Georgia', serif; color: white; }
        #mapa-fondo { position: absolute; width: 100%; height: 100vh; background-size: cover; background-position: center; transition: 5s ease; filter: brightness(0.4); }
        #caminante { position: absolute; top: 45%; left: 10%; font-size: 80px; z-index: 10; transition: 3s linear; }
        
        #narrativa { 
            position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.85); 
            padding: 40px; text-align: center; border-top: 2px solid #D4AF37; z-index: 20;
        }

        #texto-display { font-size: 1.5rem; min-height: 60px; margin-bottom: 20px; }
        .btn-opcion { background: none; border: 1px solid #D4AF37; color: white; padding: 10px 25px; margin: 5px; cursor: pointer; }
        .particle { position: absolute; background: gold; border-radius: 50%; pointer-events: none; z-index: 100; }
        @keyframes fall { to { transform: translateY(100vh); opacity: 0; } }
    </style>
</head>
<body>
    <div id="mapa-fondo"></div>
    <div id="caminante">üö∂‚Äç‚ôÇÔ∏è</div>

    <div id="narrativa">
        <div id="texto-display">Conectando...</div>
        <div id="interaccion"></div>
    </div>

    <audio id="audio-player"></audio>

    <script>
        let faseActual = 0;

        function lluviaOro() {
            for(let i=0; i<20; i++) {
                let p = document.createElement('div');
                p.className = 'particle';
                p.style.width = p.style.height = Math.random()*5+'px';
                p.style.left = Math.random()*100+'vw';
                p.style.top = '-10px';
                p.style.animation = `fall ${Math.random()*2+1}s linear forwards`;
                document.body.appendChild(p);
                setTimeout(() => p.remove(), 2000);
            }
        }

        async function ciclo() {
            try {
                const res = await fetch('/api/get_sequence');
                const data = await res.json();

                // Mover al caminante seg√∫n la fase
                faseActual = data.fase_n;
                document.getElementById('caminante').style.left = (10 + (faseActual * 8)) + "%";
                
                document.getElementById('mapa-fondo').style.backgroundImage = `url(${data.bg})`;
                document.getElementById('texto-display').innerText = data.texto;

                const player = document.getElementById('audio-player');
                player.src = `/api/get_audio?text=${encodeURIComponent(data.texto)}`;
                player.play();

                const area = document.getElementById('interaccion');
                area.innerHTML = '';

                if(data.input_requerido) {
                    const i = document.createElement('input');
                    i.type = "text"; i.placeholder = "..."; i.style.padding="10px";
                    i.onkeypress = async (e) => {
                        if(e.key === 'Enter') {
                            await fetch('/api/set_origen', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({origen: i.value})
                            });
                            ciclo();
                        }
                    };
                    area.appendChild(i);
                } else if(data.opciones) {
                    data.opciones.forEach(o => {
                        const b = document.createElement('button');
                        b.className = 'btn-opcion';
                        b.innerText = o;
                        b.onclick = () => { lluviaOro(); ciclo(); };
                        area.appendChild(b);
                    });
                }

                player.onended = () => {
                    if(data.finalizado) window.location.href='/logout';
                    else if(!data.opciones && !data.input_requerido) setTimeout(ciclo, 5000);
                };
            } catch (e) { console.log("Error de conexi√≥n, reintentando..."); setTimeout(ciclo, 3000); }
        }
        window.onload = ciclo;
    </script>
</body>
</html>
