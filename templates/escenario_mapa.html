<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KaMiZen - Experiencia Inmersiva</title>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #000; font-family: 'Georgia', serif; }
        
        #mapa-fondo { 
            position: absolute; width: 100%; height: 100vh; 
            background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)), url('https://images.unsplash.com/photo-1470770841072-f978cf4d019e?auto=format&fit=crop&w=1920&q=80'); 
            background-size: cover; background-position: center; transition: 3s filter;
        }

        #caminante { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 70px; z-index: 10; transition: 2s ease-in-out;
            filter: drop-shadow(0 0 15px rgba(212, 175, 55, 0.5));
        }

        /* Contenedor de Juegos e Im√°genes */
        #zona-juego {
            position: absolute; top: 20%; width: 100%; display: none;
            justify-content: center; gap: 20px; z-index: 15;
        }
        .img-puzzle {
            width: 120px; height: 120px; border: 2px solid #d4af37;
            cursor: grab; background-size: cover; border-radius: 8px;
        }

        #narrativa-container { 
            position: absolute; bottom: 0; width: 100%; 
            background: rgba(10, 10, 10, 0.9); color: #F5F5F5; 
            padding: 35px; box-sizing: border-box; z-index: 20;
            border-top: 3px solid #d4af37; text-align: center;
        }

        .texto-flotante {
            position: absolute; font-size: 1.2rem; color: rgba(212, 175, 55, 0.8);
            pointer-events: none; animation: floatUp 6s linear;
        }

        @keyframes floatUp { from { opacity: 0; bottom: 20%; } to { opacity: 1; bottom: 80%; } }

        .botones-area { margin-top: 20px; display: none; gap: 15px; justify-content: center; }
        .btn-opcion { 
            background: rgba(255,255,255,0.1); border: 1px solid #d4af37; color: white; 
            padding: 12px 30px; cursor: pointer; transition: 0.3s; font-size: 1rem;
        }
        .btn-opcion:hover { background: #d4af37; color: black; font-weight: bold; }
    </style>
</head>
<body>

    <div id="mapa-fondo">
        <div id="caminante">üö∂‚Äç‚ôÇÔ∏è</div>
        <div id="zona-juego">
            <div class="img-puzzle" style="background-image: url('https://cdn-icons-png.flaticon.com/512/2583/2583344.png')"></div>
            <div class="img-puzzle" style="background-image: url('https://cdn-icons-png.flaticon.com/512/1040/1040230.png')"></div>
            <div class="img-puzzle" style="background-image: url('https://cdn-icons-png.flaticon.com/512/3135/3135715.png')"></div>
        </div>
    </div>

    <div id="narrativa-container">
        <div id="texto-display">Preparando el camino de sabidur√≠a...</div>
        <div id="botones-interaccion" class="botones-area"></div>
    </div>

    <audio id="audio-player"></audio>

    <script>
        const textoDisplay = document.getElementById('texto-display');
        const audioPlayer = document.getElementById('audio-player');
        const botonesArea = document.getElementById('botones-interaccion');
        const zonaJuego = document.getElementById('zona-juego');

        function lanzarFrase(msg) {
            const f = document.createElement('div');
            f.className = 'texto-flotante';
            f.innerText = msg;
            f.style.left = Math.random() * 80 + '%';
            document.body.appendChild(f);
            setTimeout(() => f.remove(), 6000);
        }

        async function siguientePaso() {
            try {
                const res = await fetch('/api/get_sequence');
                const data = await res.json();

                textoDisplay.innerText = data.texto;
                
                // Audio profesional (esperar a que termine)
                audioPlayer.src = `/api/get_audio?text=${encodeURIComponent(data.texto)}`;
                audioPlayer.play();

                // Manejo de Juegos de Im√°genes
                zonaJuego.style.display = data.juego_imagenes ? 'flex' : 'none';

                // Manejo de Adivinanzas / Botones
                if (data.opciones) {
                    botonesArea.style.display = 'flex';
                    botonesArea.innerHTML = '';
                    data.opciones.forEach(opt => {
                        const btn = document.createElement('button');
                        btn.className = 'btn-opcion';
                        btn.innerText = opt;
                        btn.onclick = () => {
                            lanzarFrase("Elecci√≥n sabia: " + opt);
                            botonesArea.style.display = 'none';
                            siguientePaso();
                        };
                        botonesArea.appendChild(btn);
                    });
                }

                audioPlayer.onended = () => {
                    if (data.finalizado) {
                        window.location.href = '/bienestar_final';
                    } else if (!data.opciones) {
                        // Si no hay botones, pausa m√≠stica y siguiente
                        setTimeout(siguientePaso, 7000);
                    }
                };

            } catch (e) {
                setTimeout(siguientePaso, 4000);
            }
        }

        window.onload = siguientePaso;
    </script>
</body>
</html>
