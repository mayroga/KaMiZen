<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>KaMiZen - Viaje Interactivo</title>
<style>
  body, html { margin:0; padding:0; width:100%; height:100%; overflow:hidden; background:#000; font-family:'Georgia', serif; color:white;}
  #mapa { position:absolute; width:100%; height:100vh; background:#000; overflow:hidden;}
  #caminante { position:absolute; top:40%; left:0%; font-size:85px; transition: 1.5s linear; z-index:10;}
  #narrativa { position:absolute; bottom:0; width:100%; background:rgba(0,0,0,0.85); padding:40px; text-align:center; border-top:3px solid #D4AF37; box-sizing:border-box; z-index:20; }
  #texto-display { font-size:1.8rem; line-height:1.4; color:#FFF; min-height:120px; max-width:900px; margin:0 auto; }
  .fade-out { opacity:0; transition:opacity 1.5s ease; }
  .fade-in { opacity:1; transition:opacity 0.5s ease; }
  .btn-kmz { background:none; border:1px solid gold; color:gold; padding:12px 25px; margin:8px; cursor:pointer; font-size:1.1rem; }
  .btn-kmz:hover { background:gold; color:black; }
  input { background:none; border:1px solid gold; color:white; padding:12px; font-size:1.2rem; text-align:center; }
</style>
</head>
<body>
<div id="mapa">
  <canvas id="mapa-canvas" width="1920" height="1080"></canvas>
</div>
<div id="caminante">üö∂‚Äç‚ôÇÔ∏è</div>
<div id="narrativa">
  <div id="texto-display">Preparando tu viaje KaMiZen...</div>
  <div id="control"></div>
</div>
<audio id="audio-player"></audio>

<script>
const canvas = document.getElementById('mapa-canvas');
const ctx = canvas.getContext('2d');
let avatarX = 100;
let avatarY = 500;
let nodes = [];
let startTime = Date.now();
let sessionDuration = 600000; // 10 minutos
let microactions = [];
let currentNode = 0;

// Generar nodos aleatorios en el mapa (pueden ser puntos de riqueza o obst√°culos)
function generarNodos(){
  nodes = [];
  for(let i=0;i<15;i++){
    nodes.push({x:100 + i*120, y:400 + Math.sin(i)*50, tipo: i%3==0 ? 'obstaculo':'riqueza'});
  }
}

// Dibujar mapa y nodos
function dibujarMapa(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  nodes.forEach((n,i)=>{
    ctx.beginPath();
    ctx.arc(n.x, n.y, 20,0,Math.PI*2);
    ctx.fillStyle = n.tipo==='obstaculo' ? 'red' : 'gold';
    ctx.fill();
    ctx.closePath();
  });
  ctx.beginPath();
  ctx.arc(avatarX, avatarY, 25,0,Math.PI*2);
  ctx.fillStyle='white';
  ctx.fill();
  ctx.closePath();
}

// Movimiento del avatar a nodo siguiente
function moverAvatar(){
  if(currentNode >= nodes.length) return;
  let target = nodes[currentNode];
  let dx = (target.x - avatarX)*0.05;
  let dy = (target.y - avatarY)*0.05;
  avatarX += dx; avatarY += dy;
  if(Math.abs(avatarX - target.x)<2 && Math.abs(avatarY - target.y)<2){
    avatarX=target.x; avatarY=target.y;
    triggerNode(target);
    currentNode++;
  }
}

// Trigger nodo: IA decide narrativa, microacci√≥n o obst√°culo
async function triggerNode(node){
  const res = await fetch(`/api/node_action?tipo=${node.tipo}`);
  const data = await res.json();
  const display = document.getElementById('texto-display');
  escribirRapido(display,data.texto);
  // Reproducir audio
  const player = document.getElementById('audio-player');
  player.src = `/api/get_audio?text=${encodeURIComponent(data.texto)}`;
  player.play();

  const ctrl = document.getElementById('control');
  ctrl.innerHTML='';
  if(data.input){
    const i = document.createElement('input');
    i.placeholder=data.input;
    i.onkeypress=async (e)=>{
      if(e.key==='Enter'){
        await fetch('/api/micro_action',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({accion:i.value})});
      }
    };
    ctrl.appendChild(i); i.focus();
  } else if(data.opciones){
    data.opciones.forEach(o=>{
      const b=document.createElement('button');
      b.className='btn-kmz'; b.innerText=o;
      b.onclick=async ()=>{
        await fetch('/api/micro_action',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({accion:o})});
      };
      ctrl.appendChild(b);
    });
  }
}

// Escribir texto con efecto
function escribirRapido(elemento,texto){
  elemento.innerText='';
  elemento.classList.remove('fade-out');
  elemento.classList.add('fade-in');
  let i=0; let speed=30;
  function type(){
    if(i<texto.length){ elemento.innerHTML+=texto.charAt(i); i++; setTimeout(type,speed);}
  }
  type();
}

// Loop principal
function loop(){
  let elapsed = Date.now() - startTime;
  if(elapsed>sessionDuration){
    window.location='/resumen';
    return;
  }
  moverAvatar();
  dibujarMapa();
  requestAnimationFrame(loop);
}

// Inicializaci√≥n
function init(){
  generarNodos();
  loop();
}

window.onload=init;
</script>
</body>
</html>
