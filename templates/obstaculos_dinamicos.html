<!DOCTYPE html>
<html>
<head>
    <style>
        .obstacle-overlay {
            position: absolute; top: 25%; left: 50%;
            transform: translateX(-50%); z-index: 3000;
            text-align: center; width: 85%;
        }
        .obstacle-item {
            background: rgba(255, 255, 255, 0.95); padding: 30px;
            border-radius: 20px; box-shadow: 0 15px 40px rgba(0,0,0,0.2);
            border-left: 8px solid #2c3e50; animation: slideUp 0.8s ease-out;
        }
        .btn-decision {
            padding: 12px 20px; margin: 10px; border-radius: 25px;
            border: 1px solid #2c3e50; background: white;
            cursor: pointer; transition: 0.3s; font-weight: bold;
        }
        .btn-decision:hover { background: #2c3e50; color: white; }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>
    <div class="obstacle-overlay">
        <div id="obstacle-card" class="obstacle-item">
            <h3 id="obs-title">Un obstáculo en tu camino</h3>
            <p id="obs-desc">¿Cómo deseas proceder?</p>
            <div class="decision-buttons">
                <button class="btn-decision" onclick="decidir('Despejar el camino')">Despejar</button>
                <button class="btn-decision" onclick="decidir('Rodear el problema')">Rodear</button>
            </div>
            <p id="feedback-text" style="margin-top:20px; font-weight:bold; color:#2c3e50;"></p>
        </div>
    </div>
    <audio id="audio-feedback" style="display:none;"></audio>

    <script>
        async function decidir(opcion) {
            const lang = localStorage.getItem('kmz_lang') || 'en';
            const promptIA = `El usuario eligió la opción '${opcion}' ante un obstáculo. Dame una frase de sabiduría breve sobre esta elección en ${lang}.`;
            
            const res = await fetch(`/api/get_ai_feedback?prompt=${encodeURIComponent(promptIA)}`);
            const data = await res.json();
            
            document.getElementById('feedback-text').innerText = data.texto;
            
            const audio = document.getElementById('audio-feedback');
            audio.src = `/api/get_audio?text=${encodeURIComponent(data.texto)}`;
            audio.play();

            setTimeout(() => {
                document.getElementById('obstacle-card').style.opacity = '0';
                setTimeout(() => { window.parent.postMessage('obstaculo_superado', '*'); }, 1000);
            }, 5000);
        }
    </script>
</body>
</html>
