<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KaMiZen - Obstáculos Dinámicos</title>
    <style>
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #FAF9F6; color: #2C3E50; display: flex; justify-content: center; align-items: center; height: 100vh; text-align: center; }
        .container { max-width: 650px; padding: 40px; background: white; border-radius: 4px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        h2 { font-weight: 300; letter-spacing: 2px; color: #1a1a1a; }
        #obstaculo-texto { font-size: 1.3rem; margin: 30px 0; min-height: 100px; line-height: 1.6; }
        .opciones-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        button { padding: 15px; border: 1px solid #1a1a1a; background: white; color: #1a1a1a; cursor: pointer; transition: 0.3s; font-size: 1rem; }
        button:hover { background: #1a1a1a; color: white; }
        #feedback-area { margin-top: 25px; padding: 20px; background: #f9f9f9; border-left: 4px solid #d4af37; display: none; text-align: left; }
    </style>
</head>
<body>
    <div class="container">
        <h2>DESAFÍO DEL CAMINO</h2>
        <div id="obstaculo-texto">Analizando el entorno...</div>
        <div id="opciones" class="opciones-grid"></div>
        <div id="feedback-area">
            <strong id="feedback-titulo">Asesoría KaMiZen:</strong>
            <p id="feedback-texto"></p>
        </div>
    </div>

    <audio id="audio-feedback"></audio>

    <script>
        async function cargarObstaculo() {
            const res = await fetch('/api/get_sequence?lang=es');
            const data = await res.json();
            
            document.getElementById('obstaculo-texto').innerText = data.texto;
            
            // Opciones dinámicas de asesoría
            const opciones = ["Afrontar con disciplina", "Reflexionar y esperar", "Cambiar de estrategia", "Buscar una visión clara"];
            const container = document.getElementById('opciones');
            container.innerHTML = '';
            
            opciones.forEach(opt => {
                const btn = document.createElement('button');
                btn.innerText = opt;
                btn.onclick = () => procesarDecision(opt, data.texto);
                container.appendChild(btn);
            });
        }

        async function procesarDecision(decision, contexto) {
            document.getElementById('opciones').style.pointerEvents = 'none';
            const feedbackArea = document.getElementById('feedback-area');
            const prompt = `El caminante eligió "${decision}" ante el obstáculo: "${contexto}". Dame una respuesta breve de sabiduría, validando su elección como un asesor profesional.`;

            // Usamos la API de secuencia con un flag de feedback o directamente una llamada a chat
            const res = await fetch(`/api/get_sequence?lang=es&prompt_override=${encodeURIComponent(prompt)}`);
            const data = await res.json();

            document.getElementById('feedback-texto').innerText = data.texto;
            feedbackArea.style.display = 'block';

            const audio = document.getElementById('audio-feedback');
            audio.src = `/api/get_audio?text=${encodeURIComponent(data.texto)}`;
            audio.play();

            // Regresar al mapa después de la reflexión
            setTimeout(() => { window.location.href = '/servicio'; }, 8000);
        }

        window.onload = cargarObstaculo;
    </script>
</body>
</html>
